<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>英文提示詞生成器（Google Sheets 詞庫）</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial; margin: 24px; line-height: 1.5; }
    h1 { margin: 0 0 8px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 16px; margin: 14px 0; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer; background: #fff; }
    button.primary { border-color: #111; }
    input[type="text"] { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; min-width: 340px; }
    .grid { display: grid; gap: 10px; }
    .grid.cols-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
    .grid.cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .pill { display: inline-flex; gap: 8px; align-items: center; padding: 8px 10px; border: 1px solid #ddd; border-radius: 12px; }
    .pill input { transform: translateY(1px); }
    .muted { color: #666; font-size: 12px; }
    #output { font-size: 16px; white-space: pre-wrap; word-break: break-word; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
    @media (max-width: 900px) {
      .grid.cols-5 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .grid.cols-4 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      input[type="text"] { min-width: 220px; width: 100%; }
    }
  </style>
</head>
<body>
  <h1>英文提示詞生成器</h1>
  <div class="muted">資料來源：Google Sheets（每個分類一張「中文分頁」）。</div>

  <div class="card">
    <div class="row">
      <label>Spreadsheet ID：</label>
      <input id="sheetId" type="text" placeholder="貼上你的 Sheet ID（/d/ 與 /edit 之間）" />
      <button class="primary" id="btnLoad">載入詞庫</button>
    </div>
    <div class="muted" style="margin-top:8px">
      先到 Google Sheets：<b>檔案 → 發佈到網路</b>（否則前端 fetch 讀不到）。
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">勾選要生成的類別</h3>

    <div class="row" style="justify-content: space-between; align-items: flex-start;">
      <div style="flex:1; min-width: 280px;">
        <h4 style="margin:10px 0 8px">服裝區</h4>
        <div class="grid cols-5" id="boxClothes"></div>
      </div>

      <div style="flex:1; min-width: 240px;">
        <h4 style="margin:10px 0 8px">場景區</h4>
        <div class="grid cols-4" id="boxScene"></div>

        <h4 style="margin:14px 0 8px">選項</h4>
        <label class="pill">
          <input type="checkbox" id="optNsfw">
          <span>添加 NSFW</span>
        </label>
        <div class="muted" style="margin-top:6px">
          會額外從「NSFW」分頁抽詞並加入輸出（需存在 NSFW 分頁）。
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <button id="btnAll">全選</button>
      <button id="btnNone">全不選</button>
      <button class="primary" id="btnGenerate">Generate</button>
      <button id="btnCopy">Copy</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">輸出 Prompt</h3>
    <div id="output"></div>
  </div>

<script>
// ===== 1) 分類（中文顯示 + 中文分頁名）=====
const GROUPS = {
  clothes: [
    { key: "外套", label: "外套" },
    { key: "套裝", label: "套裝" },
    { key: "上衣", label: "上衣" },
    { key: "褲",   label: "褲" },
    { key: "裙",   label: "裙" },
    { key: "內衣", label: "內衣" },
    { key: "內褲", label: "內褲" },
    { key: "襪",   label: "襪" },
    { key: "鞋",   label: "鞋" },
    { key: "裝飾", label: "裝飾" }
  ],
  scene: [
    { key: "動作", label: "動作" },
    { key: "表情", label: "表情" },
    { key: "場景", label: "場景" },
    { key: "鏡頭", label: "鏡頭" }
  ]
};

// 生成順序（輸出時依此順序組合）
const OUTPUT_ORDER = [
  ...GROUPS.clothes.map(x => x.key),
  ...GROUPS.scene.map(x => x.key)
];

// 可依分類做「英文片語」包裝（可自行調整）
const FORMATTERS = {
  "場景": (term) => `in ${term}`,
  "鏡頭": (term) => `${term} shot`
};

// NSFW 分頁名
const NSFW_SHEET_NAME = "NSFW";

// ===== 2) 工具函數 =====
function csvUrl(sheetId, sheetName) {
  return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&sheet=${encodeURIComponent(sheetName)}`;
}

// 你已保證詞條不含逗號/引號，因此簡易 CSV 解析足夠
function parseCSV(csvText) {
  const lines = csvText.trim().split("\n").filter(Boolean);

  // 把表頭做標準化：去掉 BOM、去空白、轉小寫
  const rawHeaders = lines[0].split(",").map(s => s.trim());
  const headers = rawHeaders.map(h =>
    h.replace(/^\uFEFF/, "")  // 去 BOM
     .trim()
     .toLowerCase()
  );

  return lines.slice(1).map(line => {
    const cols = line.split(",").map(s => s.trim());
    const row = {};
    headers.forEach((h, i) => row[h] = (cols[i] ?? ""));
    return row;
  });
}

function normalizeRows(rows) {
  return rows
    .map(r => ({
      term: (r.term ?? "").trim(),
      weight: Number((r.weight ?? "1") || 1),
      enabled: String((r.enabled ?? "TRUE") || "TRUE").toUpperCase() !== "FALSE"
    }))
    .filter(x => x.term && x.enabled && x.weight > 0);
}

function weightedPick(items) {
  if (!items.length) return "";
  const total = items.reduce((s, x) => s + x.weight, 0);
  let r = Math.random() * total;
  for (const x of items) {
    r -= x.weight;
    if (r <= 0) return x.term;
  }
  return items[items.length - 1].term;
}

function formatTerm(category, term) {
  const f = FORMATTERS[category];
  return f ? f(term) : term;
}

// ===== 3) UI 渲染 =====
function renderGroup(containerId, items) {
  const box = document.getElementById(containerId);
  box.innerHTML = "";
  for (const it of items) {
    const el = document.createElement("label");
    el.className = "pill";
    el.innerHTML = `<input type="checkbox" checked data-cat="${it.key}"> <span>${it.label}</span>`;
    box.appendChild(el);
  }
}

function getSelectedCategories() {
  return Array.from(document.querySelectorAll('input[type="checkbox"][data-cat]'))
    .filter(cb => cb.checked)
    .map(cb => cb.dataset.cat);
}

// ===== 4) 詞庫載入 =====
let LIB = {}; // { "外套": [{term, weight, enabled}...], ... , "NSFW": [...] }

async function loadOneSheet(sheetId, sheetName) {
  const url = csvUrl(sheetId, sheetName);
  const res = await fetch(url);
  if (!res.ok) {
    throw new Error(`無法讀取分頁：「${sheetName}」\n請確認：1) 已發佈到網路 2) 分頁名稱正確`);
  }
  const csv = await res.text();
  const rows = parseCSV(csv);
  return normalizeRows(rows);
}

async function loadLibrary(sheetId) {
  const lib = {};
  const allSheets = [...OUTPUT_ORDER];
  for (const name of allSheets) {
    lib[name] = await loadOneSheet(sheetId, name);
  }

  // NSFW 是可選：只有在使用者勾選時才需要它存在，但我們這裡先嘗試載入，失敗就略過
  try {
    lib[NSFW_SHEET_NAME] = await loadOneSheet(sheetId, NSFW_SHEET_NAME);
  } catch {
    lib[NSFW_SHEET_NAME] = []; // 不存在就空
  }
  return lib;
}

// ===== 5) 生成 =====
function generatePrompt() {
  const selected = new Set(getSelectedCategories());
  const parts = [];

  for (const cat of OUTPUT_ORDER) {
    if (!selected.has(cat)) continue;
    const picked = weightedPick(LIB[cat] || []);
    if (picked) parts.push(formatTerm(cat, picked));
  }

  // NSFW
  const useNsfw = document.getElementById("optNsfw").checked;
  if (useNsfw) {
    const ns = weightedPick(LIB[NSFW_SHEET_NAME] || []);
    if (ns) parts.push(ns);
    else parts.push("nsfw"); // 若你希望沒資料就不要加，這行可刪
  }

  return parts.join(", ");
}

// ===== 初始化 =====
renderGroup("boxClothes", GROUPS.clothes);
renderGroup("boxScene", GROUPS.scene);

// ===== 事件 =====
document.getElementById("btnLoad").addEventListener("click", async () => {
  const sheetId = document.getElementById("sheetId").value.trim();
  if (!sheetId) return alert("請先輸入 Spreadsheet ID");

  try {
    document.getElementById("output").textContent = "Loading...";
    LIB = await loadLibrary(sheetId);

    const reportLines = [];
    for (const cat of OUTPUT_ORDER) {
      reportLines.push(`${cat}：${(LIB[cat] || []).length} items`);
    }
    const nsCount = (LIB[NSFW_SHEET_NAME] || []).length;
    reportLines.push(`NSFW：${nsCount} items（${nsCount ? "可用" : "未找到或為空"}）`);

    document.getElementById("output").textContent = "Loaded ✅\n" + reportLines.join("\n");
  } catch (e) {
    document.getElementById("output").textContent = "";
    alert(e.message || String(e));
  }
});

document.getElementById("btnGenerate").addEventListener("click", () => {
  if (!Object.keys(LIB).length) return alert("請先載入詞庫");
  document.getElementById("output").textContent = generatePrompt();
});

document.getElementById("btnCopy").addEventListener("click", async () => {
  const text = document.getElementById("output").textContent.trim();
  if (!text) return;
  await navigator.clipboard.writeText(text);
  alert("Copied ✅");
});

document.getElementById("btnAll").addEventListener("click", () => {
  document.querySelectorAll('input[type="checkbox"][data-cat]').forEach(cb => cb.checked = true);
});

document.getElementById("btnNone").addEventListener("click", () => {
  document.querySelectorAll('input[type="checkbox"][data-cat]').forEach(cb => cb.checked = false);
});
</script>
</body>

</html>

